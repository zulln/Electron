//
//  ScreenShot_DetectorAppDelegate.m
//  ScreenShot Detector
//
//  Created by Dave DeLong on 4/15/11.
//  Copyright 2011 __MyCompanyName__. All rights reserved.
//

#import "screenshot.h"

@implementation ScreenShot_DetectorAppDelegate

@synthesize queryResults;

- (void)run
{
	NSAlert *alert = [[NSAlert alloc] init];
	[alert addButtonWithTitle:@"OK"];
	[alert setMessageText:@"Application finished loading"];
//	[alert setInformativeText:text];
	[alert setAlertStyle:NSWarningAlertStyle];
	if ([alert runModal] == NSAlertFirstButtonReturn) {

	}
    // Insert code here to initialize your application
    query = [[NSMetadataQuery alloc] init];
    NSDate *startDate = [NSDate date];

    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(queryUpdated:) name:NSMetadataQueryDidStartGatheringNotification object:query];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(queryUpdated:) name:NSMetadataQueryDidUpdateNotification object:query];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(queryUpdated:) name:NSMetadataQueryDidFinishGatheringNotification object:query];


	//Add so that it doesn't go only with date.
	//Create initial array with objects and delete only the ones that has been added
	//since the application was started.
    [query setDelegate:self];
    [query setPredicate:[NSPredicate predicateWithFormat:@"(kMDItemContentCreationDate >= %@ && (kMDItemIsScreenCapture = 1))", startDate]];
    [query startQuery];
}

- (void)stop
{
    [query stopQuery];
    [query setDelegate:nil];
    [query release], query = nil;
    [self setQueryResults:nil];
}

- (void)queryUpdated:(NSNotification *)note {
    [self setQueryResults:[query results]];
    for(NSUInteger i=0; i<[query resultCount]; i++){
        NSMetadataItem *item = [query resultAtIndex:i];
        NSLog(@"%@", [item valueForAttribute:NSMetadataItemPathKey]);
        [[NSFileManager defaultManager] removeItemAtPath:[item valueForAttribute:NSMetadataItemPathKey] error:nil];
    }
}

@end
