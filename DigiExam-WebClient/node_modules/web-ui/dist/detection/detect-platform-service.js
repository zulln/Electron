(function(){
	"use strict";

	angular.module("dx.webui.detection").factory("detectPlatform", detectPlatformService);

	function detectPlatformService(
		$window
	) {
		var cached = false;
		var result;
		var iosRegExp = /iphone|ipod|ipad/i;

		return function detectPlatform(useCachedResult) {
			if (typeof useCachedResult === "undefined") {
				useCachedResult = true;
			}

			if (useCachedResult && cached) {
				return result;
			}

			var DX = $window.DX;
			var navigatorPlatform = $window.navigator.platform.toLowerCase();
			var navigatorUA = $window.navigator.userAgent;

			// NOTE(kenneth): These checks have not been extensively tested in the real world...

			// Allow the platform to be set explicitly.
			if (DX && DX.flags && typeof DX.flags.platform !== "undefined") {
				result = DX.flags.platform;
				cached = true;
			} else if (navigatorPlatform.indexOf("win") >= 0) {
				result = "win";
				cached = true;
			} else if (navigatorPlatform.indexOf("mac") >= 0) {
				result = "mac";
				cached = true;
			} else if (navigatorPlatform.indexOf("linux") >= 0) {
				result = "linux";
				cached = true;
			} else if (navigatorUA.indexOf("CrOS") >= 0) {
				result = "chromeos";
				cached = true;
			} else if (navigatorPlatform.match(iosRegExp)) {
				result = "ios";
				cached = true;
			}

			return result;
		};
	}
	detectPlatformService.$inject = ["$window"];
}());
