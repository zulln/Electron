(function(){
	"use strict";

	angular.module("dx.webui.blockEditor").directive("dxBlockEditorManager", blockEditorManagerDirective);

	function blockEditorManagerDirective(
		CapSettingEnum
	) {

		var directive = {
			restrict: "E",
			scope: {
				question: "=",
				answer: "=",
				onChange: "="
			},
			controllerAs: "vm",
			template: "@@include(inlineTemplate('block-editor-manager-directive.html'))",
			replace: true,
			link: link,
			controller: controller
		};

		function reduceBlockWordCount(sum, block) {
			return sum + block.wordCount;
		}

		function updateWordCount($scope) {
			var totalWordCount = $scope.answer.answerBlocks.reduce(reduceBlockWordCount, 0);
			$scope.wordCount = totalWordCount;
			if ($scope.question.capSetting === CapSettingEnum.HARD) {
				$scope.remainingWords = $scope.question.capValue - totalWordCount;
			}
		}

		function link($scope, $element) {
			$scope.wordCountEl = $element.find(".blockEditorManager_wordCount");
			updateWordCount($scope);
		}

		/*@ngInject*/
		function controller(
			$scope,
			AnswerBlockTypesEnum
		) {
			var vm = this;

			vm.AnswerBlockTypesEnum = AnswerBlockTypesEnum;

			vm.onBlockChange = function onBlockChange() {
				updateWordCount($scope);
				$scope.$apply();
				$scope.onChange($scope.answer);
			};
		}

		return directive;

	}

}());
