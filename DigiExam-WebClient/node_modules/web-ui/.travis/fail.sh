#!/bin/sh

HIPCHAT_TOKEN="ENxfQCWL0mb3UtK3uSxczfJ2kpxDLDcsktirWFKo"
ROOM_ID_DEVELOPERS="696503"

BUILD="<b>BUILD <a href='https://magnum.travis-ci.com/${TRAVIS_REPO_SLUG}/builds/${TRAVIS_BUILD_ID}'>#${TRAVIS_BUILD_NUMBER}</a> FAILED!</b>"
REPO_URL="https://github.com/${TRAVIS_REPO_SLUG}"
REPO="<a href='${REPO_URL}'>${TRAVIS_REPO_SLUG}</a>"
BRANCH="<a href='${REPO_URL}/tree/${TRAVIS_BRANCH}'>${TRAVIS_BRANCH}</a>"
HASH_FULL=`git rev-parse HEAD`
HASH_SHORT=`git rev-parse --short HEAD`
HASH="<a href='${REPO_URL}/commit/${HASH_FULL}'>${HASH_SHORT}</a>"
COMMIT_MESSAGE=`git log -1 --pretty=format:%s`
COMMIT_AUTHOR=`git log -1 --pretty=format:%an`
MESSAGE="${BUILD} Repo: ${REPO}, Branch: ${BRANCH}, Commit: ${HASH} \"${COMMIT_MESSAGE}\" by ${COMMIT_AUTHOR}"

echo "${MESSAGE}" | sed s/\"/\\\\\"/g | ./.travis/hipchat_room_message.sh -t ${HIPCHAT_TOKEN} -r ${ROOM_ID_DEVELOPERS} -f Travis -c red -v v2 -n
